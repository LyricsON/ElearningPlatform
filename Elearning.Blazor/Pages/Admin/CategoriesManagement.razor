@page "/admin/categories"
@using Elearning.Blazor.Models
@using Elearning.Blazor.Services
@inject ICategoriesApiClient CategoriesClient
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Gestion des catégories</PageTitle>

<div class="container">
    <div class="page-header">
        <h1>Gestion des catégories</h1>
        <button class="btn btn-primary" @onclick="ShowAddDialog">
            <i class="bi bi-plus-circle"></i> Ajouter une catégorie
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">Chargement...</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else if (!categories.Any())
    {
        <div class="empty-state">
            <i class="bi bi-folder" style="font-size: 4rem; opacity: 0.3;"></i>
            <h3>Aucune catégorie</h3>
            <p>Commencez par créer votre première catégorie</p>
            <button class="btn btn-primary" @onclick="ShowAddDialog">
                <i class="bi bi-plus-circle"></i> Créer une catégorie
            </button>
        </div>
    }
    else
    {
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var category in categories)
                    {
                        <tr>
                            <td>@category.Id</td>
                            <td>@category.Name</td>
                            <td>
                                <button class="btn btn-sm btn-outline" @onclick="() => ShowEditDialog(category)">
                                    <i class="bi bi-pencil"></i> Modifier
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ShowDeleteDialog(category)">
                                    <i class="bi bi-trash"></i> Supprimer
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (showDialog)
    {
        <div class="confirm-backdrop" @onclick="CloseDialog">
            <div class="confirm-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@dialogTitle</h3>
                </div>
                
                <div class="modal-body">
                    @if (isDeleteMode)
                    {
                        <p>Êtes-vous sûr de vouloir supprimer la catégorie <strong>@selectedCategory?.Name</strong> ?</p>
                        <p class="text-warning">Cette action est irréversible.</p>
                    }
                    else
                    {
                        <div class="form-group">
                            <label>Nom de la catégorie *</label>
                            <input 
                                type="text" 
                                class="input-control"
                                @bind="categoryName" 
                                @bind:event="oninput"
                                placeholder="Ex: Développement Web, Design, Marketing..." 
                                required
                                autofocus />
                            @if (string.IsNullOrWhiteSpace(categoryName) && showValidation)
                            {
                                <div class="validation-message">Le nom est requis</div>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(dialogError))
                    {
                        <div class="alert alert-danger mt-2">
                            @dialogError
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success mt-2">
                            @successMessage
                        </div>
                    }
                </div>

                <div class="confirm-actions">
                    <button class="btn btn-outline" @onclick="CloseDialog">Annuler</button>
                    @if (isDeleteMode)
                    {
                        <button class="btn btn-danger" @onclick="DeleteCategory" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Suppression...</span>
                            }
                            else
                            {
                                <span>Supprimer</span>
                            }
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-primary" @onclick="SaveCategory" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Enregistrement...</span>
                            }
                            else
                            {
                                <span>Enregistrer</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<CourseCategoryDto> categories = new();
    private bool isLoading = true;
    private string? errorMessage;
    private bool showDialog = false;
    private bool isDeleteMode = false;
    private bool isSubmitting = false;
    private string dialogTitle = "";
    private string? dialogError;
    private string? successMessage;
    private bool showValidation = false;
    private CourseCategoryDto? selectedCategory;
    private string categoryName = "";

    protected override async Task OnInitializedAsync()
    {
        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null || currentUser.Role != "Admin")
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            categories = await CategoriesClient.GetCategoriesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur lors du chargement des catégories: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddDialog()
    {
        dialogTitle = "Ajouter une catégorie";
        isDeleteMode = false;
        selectedCategory = null;
        categoryName = "";
        dialogError = null;
        showDialog = true;
    }

    private void ShowEditDialog(CourseCategoryDto category)
    {
        dialogTitle = "Modifier la catégorie";
        isDeleteMode = false;
        selectedCategory = category;
        categoryName = category.Name;
        dialogError = null;
        showDialog = true;
    }

    private void ShowDeleteDialog(CourseCategoryDto category)
    {
        dialogTitle = "Supprimer la catégorie";
        isDeleteMode = true;
        selectedCategory = category;
        dialogError = null;
        showDialog = true;
    }

    private void CloseDialog()
    {
        showDialog = false;
        selectedCategory = null;
        categoryName = "";
        dialogError = null;
        showValidation = false;
    }

    private async Task SaveCategory()
    {
        showValidation = true;
        
        if (string.IsNullOrWhiteSpace(categoryName))
        {
            dialogError = "Le nom de la catégorie est requis.";
            return;
        }

        isSubmitting = true;
        dialogError = null;
        successMessage = null;

        try
        {
            bool success;
            if (selectedCategory == null)
            {
                // Create new category
                var dto = new CreateCourseCategoryDto
                {
                    Name = categoryName
                };
                success = await CategoriesClient.CreateCategoryAsync(dto);
            }
            else
            {
                // Update existing category
                var dto = new UpdateCourseCategoryDto
                {
                    Name = categoryName
                };
                success = await CategoriesClient.UpdateCategoryAsync(selectedCategory.Id, dto);
            }

            if (success)
            {
                successMessage = selectedCategory == null 
                    ? "✅ Catégorie créée avec succès!" 
                    : "✅ Catégorie mise à jour avec succès!";
                
                await Task.Delay(1000); // Show success message briefly
                CloseDialog();
                await LoadCategories();
            }
            else
            {
                dialogError = "Échec de l'enregistrement de la catégorie.";
            }
        }
        catch (Exception ex)
        {
            dialogError = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task DeleteCategory()
    {
        if (selectedCategory == null) return;

        isSubmitting = true;
        dialogError = null;

        try
        {
            var success = await CategoriesClient.DeleteCategoryAsync(selectedCategory.Id);
            if (success)
            {
                CloseDialog();
                await LoadCategories();
            }
            else
            {
                dialogError = "Échec de la suppression de la catégorie.";
            }
        }
        catch (Exception ex)
        {
            dialogError = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
