@page "/register"
@using System.ComponentModel.DataAnnotations

@inject IAuthService AuthService
@inject NavigationManager Navigation

<div class="auth-shell">
    <div class="auth-card card">
        <h3>Inscription</h3>
        <p class="muted">Créez votre compte pour commencer à apprendre.</p>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert">@errorMessage</div>
        }

        <EditForm Model="model" OnValidSubmit="HandleRegisterAsync">
            <DataAnnotationsValidator />
            <div class="form-grid">
                <div class="form-group">
                    <label>Prénom</label>
                    <InputText class="input-control" @bind-Value="model.FirstName" />
                    <ValidationMessage For="@(() => model.FirstName)" />
                </div>
                <div class="form-group">
                    <label>Nom</label>
                    <InputText class="input-control" @bind-Value="model.LastName" />
                    <ValidationMessage For="@(() => model.LastName)" />
                </div>
            </div>
            <div class="form-group">
                <label>Email</label>
                <InputText class="input-control" @bind-Value="model.Email" />
                <ValidationMessage For="@(() => model.Email)" />
            </div>
            <div class="form-group">
                <label>Rôle</label>
                <InputRadioGroup @bind-Value="model.Role" TValue="string" class="radio-group">
                    <label class="radio-option">
                        <InputRadio Value="@("Student")" /> Étudiant
                    </label>
                    <label class="radio-option">
                        <InputRadio Value="@("Instructor")" /> Formateur
                    </label>
                </InputRadioGroup>
                <ValidationMessage For="@(() => model.Role)" />
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Mot de passe</label>
                    <InputText class="input-control" type="password" @bind-Value="model.Password" />
                    <ValidationMessage For="@(() => model.Password)" />
                </div>
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <InputText class="input-control" type="password" @bind-Value="model.ConfirmPassword" />
                    <ValidationMessage For="@(() => model.ConfirmPassword)" />
                </div>
            </div>
            <button class="btn btn-primary w-100" type="submit" disabled="@isSubmitting">
                @(isSubmitting ? "Création du compte..." : "S'inscrire")
            </button>
        </EditForm>

        <p class="muted small mt-2">
            Déjà inscrit ?
            <a href="/login">Se connecter</a>
        </p>
    </div>
</div>

@code {
    private RegisterForm model = new();
    private bool isSubmitting;
    private string? errorMessage;

    private async Task HandleRegisterAsync()
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            var success = await AuthService.RegisterAsync(new RegisterRequestDto
            {
                FirstName = model.FirstName,
                LastName = model.LastName,
                Email = model.Email,
                Role = model.Role,
                Password = model.Password,
                ConfirmPassword = model.ConfirmPassword
            });

            if (success)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Inscription impossible. Réessayez.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"L'inscription a échoué : {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private class RegisterForm
    {
        [Required, MaxLength(100)]
        public string FirstName { get; set; } = string.Empty;

        [Required, MaxLength(100)]
        public string LastName { get; set; } = string.Empty;

        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        [RegularExpression("Student|Instructor", ErrorMessage = "Choisissez Étudiant ou Formateur.")]
        public string Role { get; set; } = "Student";

        [Required, MinLength(6)]
        public string Password { get; set; } = string.Empty;

        [Required, Compare(nameof(Password), ErrorMessage = "Les mots de passe doivent correspondre.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
